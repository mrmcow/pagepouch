# Email Production Checklist ‚úÖ

**Last Updated:** November 1, 2025  
**Production Domain:** `https://pagestash.app`

## üéØ Critical Action Items

### 1. Configure Supabase Email Settings

#### A. Site URL Configuration
**Location:** Supabase Dashboard ‚Üí Authentication ‚Üí URL Configuration

**Settings to Update:**
```
Site URL: https://pagestash.app
```

**Redirect URLs (Whitelist):**
```
https://pagestash.app/**
https://www.pagestash.app/**
http://localhost:3001/**
```

**Why Critical:** Email links use this URL. If incorrect, users can't confirm emails or reset passwords.

---

#### B. Email Template Configuration
**Location:** Supabase Dashboard ‚Üí Authentication ‚Üí Email Templates

**‚ö†Ô∏è Action Required:** Copy and paste the custom templates below into Supabase.

##### 1. Confirm Signup Email

**Path:** `docs/email-templates/confirm-signup.html`

**What to Check:**
- [ ] Uses `{{ .ConfirmationURL }}` variable
- [ ] Uses `{{ .Email }}` variable
- [ ] Support email: `support@pagestash.app`
- [ ] Copyright: `¬© 2025 PageStash`
- [ ] Links point to `https://pagestash.app`

**Subject Line:** `Confirm your PageStash account`

**Template Variables:**
- `{{ .ConfirmationURL }}` - Auto-generated by Supabase
- `{{ .Email }}` - User's email address

---

##### 2. Reset Password Email

**Path:** `docs/email-templates/reset-password.html`

**What to Check:**
- [ ] Uses `{{ .ConfirmationURL }}` variable
- [ ] Uses `{{ .Email }}` variable
- [ ] Support email: `support@pagestash.app`
- [ ] Expiry time: 1 hour (matches security note)

**Subject Line:** `Reset your PageStash password`

**Template Variables:**
- `{{ .ConfirmationURL }}` - Auto-generated by Supabase
- `{{ .Email }}` - User's email address

---

##### 3. Magic Link Email (Optional)

**Path:** `docs/email-templates/magic-link.html`

**What to Check:**
- [ ] Uses `{{ .ConfirmationURL }}` variable
- [ ] Uses `{{ .Email }}` variable
- [ ] Support email: `support@pagestash.app`

**Subject Line:** `Sign in to PageStash`

**Note:** Only needed if you enable Magic Link authentication.

---

#### C. SMTP Configuration (CRITICAL for Production)

**‚ö†Ô∏è Current Issue:** Supabase's default SMTP has severe rate limits:
- **~4 emails per hour** in development
- **Not suitable for production**

**Solutions:**

##### Option 1: SendGrid (Recommended - Free Tier)
**Free Tier:** 100 emails/day

**Steps:**
1. Sign up: https://sendgrid.com
2. Create API Key (Settings ‚Üí API Keys ‚Üí Create API Key)
3. In Supabase Dashboard ‚Üí Project Settings ‚Üí Auth ‚Üí SMTP Settings:
   ```
   Enable Custom SMTP: ‚úÖ ON
   Sender email: noreply@pagestash.app
   Sender name: PageStash
   Host: smtp.sendgrid.net
   Port: 587
   Username: apikey
   Password: [Your SendGrid API Key]
   ```

##### Option 2: AWS SES
**Cost:** ~$0.10 per 1,000 emails (very cheap)

**Steps:**
1. Set up AWS SES (verify domain)
2. Get SMTP credentials
3. Configure in Supabase:
   ```
   Host: email-smtp.us-east-1.amazonaws.com
   Port: 587
   Username: [Your SMTP Username]
   Password: [Your SMTP Password]
   ```

##### Option 3: Resend.com
**Free Tier:** 3,000 emails/month

**Steps:**
1. Sign up: https://resend.com
2. Get API key
3. Configure in Supabase SMTP settings

**üö® Priority:** Set this up BEFORE launch. Without custom SMTP, users won't be able to sign up reliably.

---

### 2. Test Email Delivery in Production

#### Pre-Launch Testing Checklist

**Test 1: Signup Confirmation Email**
- [ ] Go to https://pagestash.app/auth/signup
- [ ] Sign up with real email
- [ ] Check email arrives (check spam folder)
- [ ] Click confirmation link
- [ ] Verify redirects to https://pagestash.app/dashboard
- [ ] Verify user is logged in

**Test 2: Password Reset Email**
- [ ] Go to https://pagestash.app/auth/forgot-password
- [ ] Request password reset
- [ ] Check email arrives
- [ ] Click reset link
- [ ] Verify redirects to https://pagestash.app/auth/reset-password
- [ ] Reset password successfully
- [ ] Verify redirects to dashboard

**Test 3: Magic Link Email (if enabled)**
- [ ] Go to https://pagestash.app/auth/login
- [ ] Use magic link option
- [ ] Check email arrives
- [ ] Click magic link
- [ ] Verify logs you in

**Test 4: Email Quality**
- [ ] Test in Gmail
- [ ] Test in Outlook
- [ ] Test in Apple Mail
- [ ] Test on mobile (iOS/Android)
- [ ] Check not in spam folder
- [ ] Verify all images/logos load
- [ ] Verify buttons work
- [ ] Verify links work

**Test 5: Edge Cases**
- [ ] Test with email that doesn't exist (forgot password)
- [ ] Test clicking expired confirmation link (24 hours)
- [ ] Test clicking already-used confirmation link
- [ ] Test resending confirmation email

---

### 3. Email Security Best Practices

#### SPF, DKIM, DMARC (If Using Custom Domain Email)

If you want to send from `@pagestash.app`:

**SPF Record:**
Add to DNS:
```
v=spf1 include:sendgrid.net ~all
```
(Replace `sendgrid.net` with your SMTP provider)

**DKIM:**
- SendGrid/AWS SES will provide DKIM records
- Add to your DNS

**DMARC:**
Add to DNS:
```
v=DMARC1; p=quarantine; rua=mailto:postmaster@pagestash.app
```

**Why Important:** Prevents emails going to spam folder.

---

### 4. Environment Variables

#### Production Environment (Vercel)

**Check these are set in Vercel Dashboard ‚Üí Settings ‚Üí Environment Variables:**

```bash
# Public App URL - CRITICAL for email redirects
NEXT_PUBLIC_APP_URL=https://pagestash.app

# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://[your-project].supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=[your-anon-key]
SUPABASE_SERVICE_ROLE_KEY=[your-service-key]

# Optional: Custom SMTP (if not using Supabase Dashboard)
# Usually configured in Supabase, not here
```

**Verify:**
```bash
# In production, check these resolve correctly
console.log(process.env.NEXT_PUBLIC_APP_URL) // Should be: https://pagestash.app
```

---

### 5. Code Verification

#### Email Redirect URLs

**File:** `apps/web/src/app/auth/forgot-password/page.tsx`

**Current Code:**
```typescript
const { error } = await supabase.auth.resetPasswordForEmail(email, {
  redirectTo: `${window.location.origin}/auth/reset-password`,
})
```

‚úÖ **Status:** Correct - uses dynamic origin

---

**File:** `apps/web/src/app/auth/callback/route.ts`

**Current Code:**
```typescript
const forwardedHost = request.headers.get('x-forwarded-host')
const isLocalEnv = process.env.NODE_ENV === 'development'

if (isLocalEnv) {
  return NextResponse.redirect(`${origin}${next}`)
} else if (forwardedHost) {
  return NextResponse.redirect(`https://${forwardedHost}${next}`)
} else {
  return NextResponse.redirect(`${origin}${next}`)
}
```

‚úÖ **Status:** Correct - handles both dev and production

---

### 6. Email Content Review

#### Branding Consistency

**Check all templates have:**
- [ ] PageStash logo/icon
- [ ] Blue gradient buttons (#2563eb to #4f46e5)
- [ ] Support email: `support@pagestash.app`
- [ ] Copyright: `¬© 2025 PageStash. All rights reserved.`
- [ ] Tagline: "Your Professional Web Archival Tool"

#### Security Messaging

**Each template should include:**
- [ ] "If you didn't request this..." warning
- [ ] Link expiry time (24 hours signup, 1 hour password reset)
- [ ] Support contact information

#### Call-to-Action Clarity

**Verify:**
- [ ] Primary button is obvious (blue gradient, large)
- [ ] Fallback plain text link provided
- [ ] Clear instructions ("Click the button below...")

---

### 7. Monitoring & Troubleshooting

#### Check Email Logs

**Supabase Dashboard ‚Üí Logs ‚Üí Auth Logs**

**Look for:**
- Email sent events
- Failed email delivery
- Rate limit warnings
- SMTP connection errors

#### User Reports

**If users report "no email":**
1. Check spam folder first
2. Check Supabase logs for that email
3. Verify SMTP configuration
4. Check rate limits
5. Test with your own email

#### Common Issues

| Issue | Cause | Solution |
|-------|-------|----------|
| Email not arriving | Rate limit hit | Set up custom SMTP |
| Link doesn't work | Wrong Site URL | Update in Supabase Dashboard |
| Goes to spam | No SPF/DKIM | Configure DNS records |
| 404 after clicking link | Redirect URL not whitelisted | Add to Redirect URLs |
| Expired link error | Link older than expiry | User must request new one |

---

## üìã Pre-Launch Checklist

### Before Going Live:

- [ ] 1. Update Supabase Site URL to `https://pagestash.app`
- [ ] 2. Add production domain to Redirect URLs whitelist
- [ ] 3. Configure custom SMTP (SendGrid/AWS SES/Resend)
- [ ] 4. Copy custom HTML templates to Supabase Email Templates
- [ ] 5. Update support email to `support@pagestash.app` in all templates
- [ ] 6. Test signup email end-to-end
- [ ] 7. Test password reset email end-to-end
- [ ] 8. Test emails in Gmail, Outlook, Apple Mail
- [ ] 9. Test on mobile devices
- [ ] 10. Configure SPF/DKIM records (if using custom domain)
- [ ] 11. Set up email monitoring/alerts
- [ ] 12. Document support process for "email not received" issues

### After Launch:

- [ ] Monitor email delivery rates
- [ ] Check spam folder rates (ask users)
- [ ] Review Supabase Auth logs daily for first week
- [ ] Set up alerting for failed email delivery
- [ ] Consider email analytics (open rates, click rates)

---

## üÜò Emergency Contacts

**If emails completely stop working:**

1. **Check Supabase Status:** https://status.supabase.com
2. **Check SMTP Provider Status:** (SendGrid status page, etc.)
3. **Fallback:** Temporarily disable email confirmation in Supabase (NOT recommended for production)

**Support Channels:**
- Supabase Support: https://supabase.com/support
- SendGrid Support: https://support.sendgrid.com

---

## üìä Recommended Monitoring

**Metrics to Track:**
- Email delivery rate (successful sends / attempted sends)
- Time to delivery (should be < 30 seconds)
- Spam folder rate
- Confirmation click-through rate
- Failed auth attempts due to unconfirmed emails

**Tools:**
- Supabase built-in logs
- SMTP provider dashboard (SendGrid analytics, etc.)
- Custom logging in your auth routes (optional)

---

## üîÑ Regular Maintenance

**Monthly:**
- [ ] Review email delivery metrics
- [ ] Check for any failed sends
- [ ] Verify SMTP credentials still valid
- [ ] Update templates if branding changes

**Quarterly:**
- [ ] Test full email flow on different devices
- [ ] Review spam folder rates
- [ ] Update security notes if needed
- [ ] Check DNS records (SPF/DKIM) still valid

---

## ‚úÖ Quick Win: Update Templates Right Now

**Fastest way to get production-ready:**

1. Open Supabase Dashboard
2. Go to Authentication ‚Üí Email Templates
3. For each template (Confirm Signup, Reset Password):
   - Copy HTML from `docs/email-templates/[template-name].html`
   - Paste into Supabase template editor
   - Click Save
4. Update Site URL to `https://pagestash.app`
5. Add `https://pagestash.app/**` to Redirect URLs
6. Test with your own email

**Time required:** 10-15 minutes  
**Impact:** Professional, branded emails immediately

---

## üìù Notes

**Current Status:**
- ‚úÖ Professional HTML templates created
- ‚úÖ Auth routes implemented correctly
- ‚úÖ Production domain configured in code
- ‚ö†Ô∏è Templates need to be copied to Supabase Dashboard
- ‚ö†Ô∏è Custom SMTP needs to be configured
- ‚ö†Ô∏è Production testing needed

**Priority:** **HIGH** - Required before public launch

---

**Document Owner:** Development Team  
**Last Review:** November 1, 2025  
**Next Review:** Before production launch

