console.log("ü¶ä Firefox popup script loaded");const extensionAPI="undefined"!=typeof browser?browser:chrome;console.log("ü¶ä Using extension API:","undefined"!=typeof browser?"browser":"chrome");let appState={isCapturing:!1,isAuthenticated:!1,captureCount:0,showAuth:!1,currentTab:null,userEmail:null,captureProgress:null},authState={email:"",password:"",isSignUp:!1,isLoading:!1,error:null};const styles={container:'width: 360px; min-height: 480px; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background-color: #ffffff; color: #1f2937; font-size: 14px; line-height: 1.5; display: flex; flex-direction: column;',header:"padding: 16px 20px 12px 20px; display: flex; flex-direction: column; align-items: center; text-align: center; border-bottom: 1px solid #f1f5f9;",logoSection:"display: flex; flex-direction: column; align-items: center; gap: 6px; margin-bottom: 8px;",brandName:"font-size: 20px; font-weight: 700; color: #1e293b; margin: 0; letter-spacing: -0.025em; text-align: center;",content:"padding: 16px 20px; flex: 1; display: flex; flex-direction: column; align-items: center; gap: 12px;",button:"padding: 14px 24px; border-radius: 12px; border: none; font-weight: 500; font-size: 14px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; max-width: 280px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);",primaryButton:"background-color: #3b82f6; color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);",secondaryButton:"background-color: #ffffff; color: #475569; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);",input:"width: 100%; max-width: 280px; padding: 14px 16px; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 14px; margin-bottom: 16px; box-sizing: border-box; background-color: #ffffff; transition: all 0.2s ease; outline: none; text-align: center;",card:"background-color: #f8fafc; border: 1px solid #f1f5f9; border-radius: 12px; padding: 20px; width: 100%; max-width: 280px; text-align: center; box-sizing: border-box;",badge:"display: inline-flex; align-items: center; padding: 4px 8px; background-color: #dbeafe; color: #1d4ed8; border-radius: 12px; font-size: 12px; font-weight: 500;",tabInfo:"display: flex; align-items: flex-start; gap: 12px; padding: 16px; background-color: #f8fafc; border-radius: 12px; border: 1px solid #f1f5f9; width: 100%; max-width: 280px; box-sizing: border-box; flex-direction: column; text-align: center;"};function createLogo(t=32){return`\n    <svg width="${t}" height="${t}" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0 4px 12px rgba(59, 130, 246, 0.3));">\n      <defs>\n        <filter id="emboss-${t}" x="-20%" y="-20%" width="140%" height="140%">\n          <feDropShadow dx="0.5" dy="0.5" stdDeviation="0.3" floodColor="#1d4ed8" floodOpacity="0.3"/>\n        </filter>\n      </defs>\n      <path d="M9 6C9 4.89543 9.89543 4 11 4H35C36.1046 4 37 4.89543 37 6V40C37 41.1046 36.1046 42 35 42H11C9.89543 42 9 41.1046 9 40V6Z" fill="#f8fafc" stroke="#2563eb" stroke-width="2"/>\n      <path d="M37 6V18L42 13V8C42 6.89543 41.1046 6 40 6H37Z" fill="#2563eb" stroke="#2563eb" stroke-width="2" stroke-linejoin="round"/>\n      <path d="M38.5 9.5V15.5M38.5 9.5H40C40.5523 9.5 41 9.94772 41 10.5V11.5C41 12.0523 40.5523 12.5 40 12.5H38.5M38.5 9.5V12.5" stroke="#ffffff" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" filter="url(#emboss-${t})"/>\n      <rect x="15" y="14" width="14" height="1.5" rx="0.75" fill="#64748b" opacity="0.3"/>\n      <rect x="15" y="18" width="10" height="1.5" rx="0.75" fill="#64748b" opacity="0.3"/>\n      <rect x="15" y="22" width="12" height="1.5" rx="0.75" fill="#64748b" opacity="0.3"/>\n    </svg>\n  `}function createElement(t,e={},a=[]){const n=document.createElement(t);return Object.entries(e).forEach(([t,e])=>{"style"===t?n.setAttribute("style",e):"onClick"===t?n.addEventListener("click",e):n.setAttribute(t,e)}),a.forEach(t=>{"string"==typeof t?n.innerHTML+=t:n.appendChild(t)}),n}async function checkAuthStatus(){try{console.log("ü¶ä Checking auth status...");const t=await extensionAPI.storage.local.get(["authToken","userEmail","captureCount"]);console.log("ü¶ä Storage result:",t),t?(appState.isAuthenticated=!!t.authToken,appState.userEmail=t.userEmail,appState.captureCount=t.captureCount||0,console.log("ü¶ä Auth status:",appState.isAuthenticated,"Email:",appState.userEmail)):(console.log("ü¶ä No storage result, setting defaults"),appState.isAuthenticated=!1,appState.userEmail=null,appState.captureCount=0)}catch(t){console.error("ü¶ä Error checking auth status:",t),appState.isAuthenticated=!1,appState.userEmail=null,appState.captureCount=0}}async function getCurrentTab(){try{console.log("ü¶ä Getting current tab...");const t=await extensionAPI.tabs.query({active:!0,currentWindow:!0});console.log("ü¶ä Tabs result:",t),t&&t.length>0&&t[0]?(appState.currentTab=t[0],console.log("ü¶ä Current tab:",appState.currentTab.title)):(console.log("ü¶ä No active tab found"),appState.currentTab=null)}catch(t){console.error("ü¶ä Error getting current tab:",t),appState.currentTab=null}}async function capturePage(t){if(appState.currentTab?.id){if(!appState.isAuthenticated)return appState.showAuth=!0,void render();appState.isCapturing=!0,appState.captureProgress={status:"starting",message:"fullPage"===t?"Preparing full page capture...":"Preparing visible area capture..."},render();try{setTimeout(()=>{appState.captureProgress={status:"capturing",message:"fullPage"===t?"Capturing full page...":"Capturing visible area..."},render()},100),await extensionAPI.runtime.sendMessage({type:"CAPTURE_PAGE",payload:{tabId:appState.currentTab.id,captureType:t,url:appState.currentTab.url,title:appState.currentTab.title}}),appState.captureProgress={status:"complete",message:"Capture successful! üéâ"},render(),setTimeout(()=>{appState.isCapturing=!1,appState.captureProgress=null,render()},2e3)}catch(t){console.error("Capture failed:",t),appState.isCapturing=!1,appState.captureProgress={status:"error",message:"Capture failed. Please refresh the page and try again."},render(),setTimeout(()=>{appState.captureProgress=null,render()},3e3)}}}async function handleAuth(){authState.isLoading=!0,authState.error=null,render();try{console.log("ü¶ä Sending auth request:",{email:authState.email,isSignUp:authState.isSignUp});const t=await extensionAPI.runtime.sendMessage({type:"AUTHENTICATE",payload:{email:authState.email,password:authState.password,isSignUp:authState.isSignUp}});if(console.log("ü¶ä Auth response received:",t),t&&t.error)return console.error("ü¶ä Auth failed:",t.error),authState.error=t.error.message||"Authentication failed",authState.isLoading=!1,void render();if(!t||!t.data)return console.error("ü¶ä Invalid response:",t),authState.error="Invalid response from server",authState.isLoading=!1,void render();console.log("ü¶ä Auth successful!"),appState.isAuthenticated=!0,appState.userEmail=authState.email,appState.showAuth=!1,authState={email:"",password:"",isSignUp:!1,isLoading:!1,error:null},render()}catch(t){console.error("ü¶ä Auth error:",t),authState.error="Authentication failed. Please try again.",authState.isLoading=!1,render()}}async function signOut(){try{await extensionAPI.runtime.sendMessage({type:"SIGN_OUT"}),appState.isAuthenticated=!1,appState.userEmail=null,appState.showAuth=!1,render()}catch(t){console.error("Sign out failed:",t),await extensionAPI.storage.local.remove(["authToken","userEmail","userId","refreshToken","isAuthenticated"]),appState.isAuthenticated=!1,appState.userEmail=null,render()}}function updateAuthButtonState(){const t=document.getElementById("auth-submit");if(t){const e=!authState.isLoading&&authState.email&&authState.password;t.disabled=!e,t.style.opacity=e?"1":"0.6"}}function renderAuthScreen(){return`\n    <div style="${styles.container}">\n      <div style="${styles.header}">\n        <div style="${styles.logoSection}">\n          ${createLogo(32)}\n          <h1 style="${styles.brandName}">PagePouch</h1>\n        </div>\n        <button id="close-auth" style="position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 20px; cursor: pointer; color: #64748b; width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center;">√ó</button>\n      </div>\n      <div style="${styles.content}">\n        <div style="text-align: center; margin-bottom: 24px;">\n          <h2 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600;">${authState.isSignUp?"Create Account":"Sign In"}</h2>\n          <p style="margin: 0; color: #6b7280; font-size: 13px;">${authState.isSignUp?"Start capturing and organizing web content":"Access your PagePouch library"}</p>\n        </div>\n        <input id="email-input" type="email" placeholder="Email" value="${authState.email}" style="${styles.input}">\n        <input id="password-input" type="password" placeholder="Password" value="${authState.password}" style="${styles.input}">\n        ${authState.error?`<div style="color: #dc2626; font-size: 12px; margin-top: 4px;">${authState.error}</div>`:""}\n        <button id="auth-submit" ${!authState.isLoading&&authState.email&&authState.password?"":"disabled"} style="${styles.button}; ${styles.primaryButton}; opacity: ${!authState.isLoading&&authState.email&&authState.password?"1":"0.6"};">\n          ${authState.isLoading?"‚è≥ Processing...":authState.isSignUp?"Create Account":"Sign In"}\n        </button>\n        <button id="auth-toggle" style="${styles.button}; ${styles.secondaryButton};">\n          ${authState.isSignUp?"Already have an account? Sign In":"Need an account? Sign Up"}\n        </button>\n      </div>\n    </div>\n  `}function renderMainScreen(){return`\n    <div style="${styles.container}">\n      <div style="${styles.header}">\n        <div style="${styles.logoSection}">\n          ${createLogo(40)}\n          <h1 style="${styles.brandName}">PagePouch</h1>\n          ${appState.isAuthenticated?`<div style="${styles.badge}">${appState.captureCount} clips</div>`:""}\n        </div>\n      </div>\n      <div style="${styles.content}">\n        ${appState.currentTab?`\n          <div style="${styles.tabInfo}">\n            ${appState.currentTab.favIconUrl?`<img src="${appState.currentTab.favIconUrl}" alt="Site icon" style="width: 16px; height: 16px; border-radius: 2px; margin-bottom: 4px;">`:""}\n            <div style="text-align: center; width: 100%;">\n              <div style="font-weight: 500; font-size: 13px; text-align: center; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${appState.currentTab.title||"Untitled"}</div>\n              <div style="font-size: 11px; color: #6b7280; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${appState.currentTab.url}</div>\n            </div>\n          </div>\n        `:""}\n        \n        ${appState.captureProgress?`\n          <div style="${styles.card}; background-color: ${"error"===appState.captureProgress.status?"#fef2f2":"complete"===appState.captureProgress.status?"#f0fdf4":"#f0f9ff"}; border: ${"error"===appState.captureProgress.status?"1px solid #fecaca":"complete"===appState.captureProgress.status?"1px solid #bbf7d0":"1px solid #bfdbfe"};">\n            <div style="margin-bottom: 12px; font-weight: 600; color: ${"error"===appState.captureProgress.status?"#dc2626":"complete"===appState.captureProgress.status?"#16a34a":"#2563eb"};">\n              ${"complete"===appState.captureProgress.status?"‚úÖ Capture Complete!":"error"===appState.captureProgress.status?"‚ùå Capture Failed":"üì∏ Capturing..."}\n            </div>\n            ${"error"!==appState.captureProgress.status?`\n              <div style="width: 100%; height: 4px; background-color: #e5e7eb; border-radius: 2px; overflow: hidden; margin-bottom: 8px;">\n                <div style="height: 100%; background-color: ${"complete"===appState.captureProgress.status?"#16a34a":"#2563eb"}; border-radius: 2px; transition: width 0.3s ease; width: ${"complete"===appState.captureProgress.status?"100%":"capturing"===appState.captureProgress.status?"75%":"25%"};"></div>\n              </div>\n            `:""}\n            <div style="font-size: 13px; color: ${"error"===appState.captureProgress.status?"#dc2626":"#6b7280"}; margin-top: 8px;">${appState.captureProgress.message}</div>\n          </div>\n        `:""}\n        \n        ${appState.isCapturing||appState.captureProgress?"":`\n          <button id="capture-full" style="${styles.button}; ${styles.primaryButton};">üìÑ Capture Full Page</button>\n          <button id="capture-visible" style="${styles.button}; ${styles.secondaryButton};">üì± Capture Visible Area</button>\n        `}\n        \n        ${appState.isAuthenticated?`\n          <div style="${styles.card}">\n            <div style="margin-bottom: 12px;">\n              <div style="font-weight: 500; margin-bottom: 4px;">üëã Welcome back!</div>\n              <div style="font-size: 12px; color: #6b7280;">${appState.userEmail}</div>\n            </div>\n            <button id="open-webapp" style="${styles.button}; ${styles.primaryButton};">üåê Open Web App</button>\n            <button id="sign-out" style="${styles.button}; ${styles.secondaryButton};">Sign Out</button>\n          </div>\n        `:`\n          <div style="${styles.card}">\n            <div style="margin-bottom: 12px;">\n              <div style="font-weight: 500; margin-bottom: 4px;">üîí Sign in for cloud sync</div>\n              <div style="font-size: 12px; color: #6b7280;">Access your clips anywhere and never lose them</div>\n            </div>\n            <button id="show-auth" style="${styles.button}; ${styles.secondaryButton};">Sign In / Sign Up</button>\n          </div>\n        `}\n        \n        <div style="text-align: center; margin-top: auto; padding-top: 24px; border-top: 1px solid #f1f5f9; font-size: 12px; color: #94a3b8;">\n          <div style="font-weight: 500; margin-bottom: 4px;">PagePouch v1.1.0</div>\n          <div>Capture ‚Ä¢ Organize ‚Ä¢ Retrieve</div>\n        </div>\n      </div>\n    </div>\n  `}function render(){const t=document.getElementById("popup-root");if(t)if(t.innerHTML=appState.showAuth?renderAuthScreen():renderMainScreen(),appState.showAuth){const t=document.getElementById("close-auth"),e=document.getElementById("email-input"),a=document.getElementById("password-input"),n=document.getElementById("auth-submit"),r=document.getElementById("auth-toggle");t&&t.addEventListener("click",()=>{appState.showAuth=!1,render()}),e&&e.addEventListener("input",t=>{authState.email=t.target.value,updateAuthButtonState()}),a&&a.addEventListener("input",t=>{authState.password=t.target.value,updateAuthButtonState()}),n&&n.addEventListener("click",handleAuth),r&&r.addEventListener("click",()=>{authState.isSignUp=!authState.isSignUp,authState.error=null,render()})}else{const t=document.getElementById("capture-full"),e=document.getElementById("capture-visible"),a=document.getElementById("show-auth"),n=document.getElementById("sign-out"),r=document.getElementById("open-webapp");t&&t.addEventListener("click",()=>capturePage("fullPage")),e&&e.addEventListener("click",()=>capturePage("visible")),a&&a.addEventListener("click",()=>{appState.showAuth=!0,render()}),n&&n.addEventListener("click",signOut),r&&r.addEventListener("click",()=>{extensionAPI.tabs.create({url:"https://pagepouch-web.vercel.app/dashboard"})})}else console.error("popup-root not found")}async function init(){console.log("ü¶ä Initializing Firefox popup"),await checkAuthStatus(),await getCurrentTab(),extensionAPI.runtime.onMessage.addListener(t=>{"CAPTURE_PROGRESS"===t.type&&(appState.captureProgress={status:t.payload.status,message:t.payload.message},render(),"complete"===t.payload.status&&setTimeout(()=>{appState.captureProgress=null,appState.isCapturing=!1,render()},2e3))}),render(),console.log("ü¶ä Firefox popup initialized")}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",init):init();